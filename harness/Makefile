
#include ../Makefile.config

CXX = g++
CXXFLAGS = -O3 -g -fPIC -std=c++0x -lrt
COMMON_INCLUDES = dist.h helpers.h msgs.h

PCM_FOLDER = ../IntelPerformanceCounterMonitorV2.8
PCM_FILES = $(PCM_FOLDER)/msr.cpp $(PCM_FOLDER)/cpucounters.cpp $(PCM_FOLDER)/pci.cpp \
        $(PCM_FOLDER)/client_bw.cpp $(PCM_FOLDER)/utils.cpp

default: client.o tbench_server_integrated.o tbench_server_networked.o \
	tbench_client_networked.o tbench.jar

client.o : client.cpp client.h $(COMMON_INCLUDES)
	$(CXX) $(CXXFLAGS) -c $< -o $@

tbench_server_integrated.o : tbench_server_integrated.cpp tbench_server.h \
	server.h client.h $(COMMON_INCLUDES)
	$(CXX) $(CXXFLAGS) -c $< -o $@

tbench_server_networked.o : networked_server_unity.cpp tbench_server_networked.cpp tbench_server.h \
	server.h $(COMMON_INCLUDES) $(PCM_FILES)
	$(CXX) $(CXXFLAGS) -c $<  -o $@  -pthread

tbench_client_networked.o : tbench_client_networked.cpp tbench_client.h \
	server.h client.h $(COMMON_INCLUDES)
	$(CXX) $(CXXFLAGS) -c $< -o $@

tbench/tbench.class : tbench/tbench.java
	$(JDK_PATH)/bin/javac tbench/tbench.java

tbench.jar: tbench/tbench.class tbench_jni.cpp
	# If you change the API in tbench/tbench.java, it will reflect in a change
	# in API in tbench_tbench.h auto-generated by javah. You must make sure to
	# make the corresponding changes to tbench_jni.cpp
	$(JDK_PATH)/bin/javah tbench.tbench
	$(CXX) $(CXXFLAGS) -I $(JDK_PATH)/include -I $(JDK_PATH)/include/linux \
		-c tbench_jni.cpp -o tbench_jni.o
	$(JDK_PATH)/bin/jar cf $@ $<

clean:
	rm *.o tbench/tbench.class tbench_tbench.h tbench.jar

